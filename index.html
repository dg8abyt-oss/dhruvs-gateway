<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Appex Vibe Coder - Live Preview</title>
    
    <link rel="manifest" href="/manifest.json">
    <link rel="icon" href="https://ik.imagekit.io/migbb/vibe-coding.png?updatedAt=1771554953655" type="image/png" sizes="200x200" />
    <meta name="theme-color" content="#0f172a">

    <script src="https://cdn.tailwindcss.com"></script>
    
    <script src="https://gateway.dhruvs.host/widget.js" defer></script>

    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>

    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/github-dark.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>
    <script>hljs.highlightAll();</script>

    <style>
        /* Modern Scrollbar */
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #334155; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #475569; }
        body { font-family: 'Inter', sans-serif; }
        .code-header { background-color: #1e293b; }
        .code-content { background-color: #0d1117; }
    </style>
</head>
<body class="bg-slate-950 text-slate-200 h-screen flex overflow-hidden">

    <div class="flex w-full h-full">

        <div class="w-1/3 flex flex-col border-r border-slate-800 bg-slate-950">
            
            <div id="chat-container" class="flex-1 overflow-y-auto p-4 space-y-4">
                <div class="flex flex-col items-start">
                    <div class="flex items-center gap-2 text-purple-400 mb-1">
                        <span class="font-semibold text-sm">Appex Agent</span>
                    </div>
                    <div class="p-3 rounded-2xl rounded-tl-none bg-slate-800/50 border border-slate-700 shadow-sm text-sm text-slate-300">
                        Ready to vibe code. Describe what you want, and I'll generate the files.
                    </div>
                </div>
            </div>

            <div class="p-4 border-t border-slate-800 bg-slate-900">
                <div class="relative flex">
                    <textarea id="prompt-input" rows="1" placeholder="e.g., Build a modern login screen" 
                        class="w-full bg-slate-800 border border-slate-700 focus:border-blue-500 rounded-xl px-4 py-3 pr-12 outline-none resize-none shadow-sm transition-all text-slate-200 placeholder-slate-500"></textarea>
                    <button onclick="sendToAI()" class="absolute right-2 bottom-2 p-2 bg-blue-600 hover:bg-blue-500 text-white rounded-lg transition-transform active:scale-95">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                            <path d="M10.894 2.553a1 1 0 00-1.788 0l-7 14a1 1 0 001.169 1.409l5-1.429A1 1 0 009 15.571V11a1 1 0 112 0v4.571a1 1 0 00.725.962l5 1.428a1 1 0 001.17-1.408l-7-14z" />
                        </svg>
                    </button>
                </div>
            </div>

        </div>

        <div class="w-2/3 flex flex-col bg-[#0d1117]">
            
            <div class="code-header flex items-center justify-between p-4 border-b border-slate-800">
                <div class="flex items-center gap-4">
                    <div id="file-name" class="font-mono text-sm font-semibold text-yellow-400 bg-yellow-400/10 px-3 py-1 rounded">
                        code.js
                    </div>
                    
                    <div id="view-toggles" class="hidden flex bg-slate-900 rounded-lg p-1 border border-slate-700">
                        <button id="btn-code" onclick="toggleView('code')" class="px-3 py-1 text-sm rounded-md bg-slate-700 text-white font-medium transition">Code</button>
                        <button id="btn-preview" onclick="toggleView('preview')" class="px-3 py-1 text-sm rounded-md text-slate-400 hover:text-white transition">Preview</button>
                    </div>
                </div>

                <button onclick="downloadCode()" class="flex items-center gap-2 bg-blue-600 hover:bg-blue-500 text-white px-3 py-1.5 rounded-md text-sm transition">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 20 20" fill="currentColor">
                        <path fill-rule="evenodd" d="M3 17a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zm3.293-7.707a1 1 0 011.414 0L9 10.586V3a1 1 0 112 0v7.586l1.293-1.293a1 1 0 111.414 1.414l-3 3a1 1 0 01-1.414 0l-3-3a1 1 0 010-1.414z" clip-rule="evenodd" />
                    </svg>
                    Download
                </button>
            </div>
            
            <div class="flex-1 relative overflow-auto p-4">
                <pre id="code-container" class="m-0 h-full"><code id="code-display" class="language-javascript text-sm font-mono h-full block">/*
  Your generated code will appear here.
  Start by describing what you want to build in the chat.
*/</code></pre>

                <iframe id="preview-frame" class="w-full h-full bg-white rounded-md hidden border-none" sandbox="allow-scripts allow-forms allow-same-origin allow-modals"></iframe>
            </div>
        </div>

    </div>

<script>
        const chatContainer = document.getElementById('chat-container');
        const inputField = document.getElementById('prompt-input');
        
        const codeDisplay = document.getElementById('code-display');
        const codeContainer = document.getElementById('code-container');
        const fileNameDisplay = document.getElementById('file-name');
        
        const previewFrame = document.getElementById('preview-frame');
        const viewToggles = document.getElementById('view-toggles');
        const btnCode = document.getElementById('btn-code');
        const btnPreview = document.getElementById('btn-preview');

        let currentCode = "";
        let currentLanguage = "html";

        // Auto-resize textarea
        inputField.addEventListener('input', function() {
            this.style.height = 'auto';
            this.style.height = (this.scrollHeight) + 'px';
            if(this.value === '') this.style.height = 'auto';
        });

        // Allow 'Enter' to send, 'Shift+Enter' for new line
        inputField.addEventListener('keydown', function(e) {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                sendToAI();
            }
        });

        function appendMessage(role, text) {
            const isUser = role === 'user';
            // Simple clean up to remove the code block from the chat UI so the chat looks cleaner
            let chatText = text;
            if (!isUser) {
                chatText = chatText.replace(/\((.*?)\)\s*([\s\S]*?)--end/gi, '[Code generated in panel]');
            }

            const html = `
                <div class="flex flex-col ${isUser ? 'items-end' : 'items-start'}">
                    <div class="flex items-center gap-2 mb-1 ${isUser ? 'text-blue-400 flex-row-reverse' : 'text-purple-400'}">
                        <span class="font-semibold text-sm">${isUser ? 'You' : 'Appex Agent'}</span>
                    </div>
                    <div class="p-3 rounded-2xl ${isUser ? 'bg-blue-600/10 border-blue-500/30 rounded-tr-none text-slate-200' : 'bg-slate-800/50 border-slate-700 rounded-tl-none text-slate-300'} shadow-sm text-sm whitespace-pre-wrap">${chatText.replace(/</g, "&lt;").replace(/>/g, "&gt;")}</div>
                </div>
            `;
            chatContainer.insertAdjacentHTML('beforeend', html);
            chatContainer.scrollTop = chatContainer.scrollHeight;
        }

        function toggleView(view) {
            if (view === 'preview') {
                codeContainer.classList.add('hidden');
                previewFrame.classList.remove('hidden');
                previewFrame.srcdoc = currentCode;

                btnPreview.classList.add('bg-slate-700', 'text-white', 'font-medium');
                btnPreview.classList.remove('text-slate-400');
                btnCode.classList.remove('bg-slate-700', 'text-white', 'font-medium');
                btnCode.classList.add('text-slate-400');
            } else {
                previewFrame.classList.add('hidden');
                codeContainer.classList.remove('hidden');

                btnCode.classList.add('bg-slate-700', 'text-white', 'font-medium');
                btnCode.classList.remove('text-slate-400');
                btnPreview.classList.remove('bg-slate-700', 'text-white', 'font-medium');
                btnPreview.classList.add('text-slate-400');
            }
        }

        function updateCodeDisplay(text) {
            // CUSTOM PARSER: Looks for (filename.ext) ... --end
            const regex = /\((.*?)\)\s*([\s\S]*?)--end/i;
            const match = text.match(regex);

            if (match && match.length >= 3) {
                const fileName = match[1].trim();
                currentCode = match[2].trim();
                
                // Determine language based on the file extension the AI provided
                const ext = fileName.split('.').pop().toLowerCase();
                currentLanguage = ext === 'js' ? 'javascript' : 
                                  ext === 'html' ? 'html' : 
                                  ext === 'css' ? 'css' : 
                                  ext === 'json' ? 'json' : 'txt';
                
                fileNameDisplay.textContent = fileName;
            } else {
                // FALLBACK: If the AI messes up the format
                console.log("Custom format not found, using raw text fallback.");
                currentCode = text.trim();
                currentLanguage = 'html'; 
                fileNameDisplay.textContent = 'index.html';
            }

            // Force reset Highlight.js
            codeDisplay.removeAttribute('data-highlighted');

            // Update code block UI
            codeDisplay.className = `language-${currentLanguage} text-sm font-mono h-full block`;
            codeDisplay.textContent = currentCode;
            hljs.highlightElement(codeDisplay);

            // Toggle logic: Only show preview button if it's HTML
            if (currentLanguage === 'html') {
                viewToggles.classList.remove('hidden');
                toggleView('preview');
            } else {
                viewToggles.classList.add('hidden');
                toggleView('code'); 
            }
        }

        function downloadCode() {
            if (!currentCode) return;
            const blob = new Blob([currentCode], { type: 'text/plain' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.style.display = 'none';
            a.href = url;
            a.download = fileNameDisplay.textContent;
            document.body.appendChild(a);
            a.click();
            window.URL.revokeObjectURL(url);
            document.body.removeChild(a);
        }

        async function sendToAI() {
            const prompt = inputField.value.trim();
            if (!prompt) return;

            inputField.value = '';
            inputField.style.height = 'auto';
            appendMessage('user', prompt);

            const loadingId = 'loading-' + Date.now();
            chatContainer.insertAdjacentHTML('beforeend', `<div id="${loadingId}" class="flex flex-col items-start animate-pulse"><div class="p-3 rounded-2xl rounded-tl-none bg-slate-800/50 border border-slate-700 shadow-sm text-sm text-slate-500">Generating code...</div></div>`);
            chatContainer.scrollTop = chatContainer.scrollHeight;

            try {
                if (typeof window.dhruvs !== "function") {
                    throw new Error("Gateway script not loaded or blocked.");
                }

                const reply = await window.dhruvs(
                    "gateway-call", 
                    prompt, 
                    "google/gemini-3.0-pro",
                    true 
                );
                
                document.getElementById(loadingId).remove();
                
                // Update the code panel
                updateCodeDisplay(reply);
                
                // Append the chat message (the appendMessage function will now strip out the ugly code block from the chat UI)
                appendMessage('ai', reply);

            } catch (err) {
                document.getElementById(loadingId).remove();
                appendMessage('ai', `⚠️ Error: ${err.message}.`);
            }
        }

        // Register Service Worker for PWA
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('/sw.js');
            });
        }
    </script>
</body>
</html>
